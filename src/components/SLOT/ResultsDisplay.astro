{/* Results display with history panel */}

<div class="p-6 rounded-3xl bg-white/70 dark:bg-zinc-900/70 border border-white/60 dark:border-zinc-700/50 shadow-lg">
  <h2 class="text-xl font-bold text-zinc-800 dark:text-zinc-100 mb-4">
    Hasil & Riwayat
  </h2>
  
  {/* Empty state (shown initially) */}
  <div id="results-empty-state" class="text-center py-12">
    <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-zinc-100 dark:bg-zinc-800 flex items-center justify-center">
      <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-zinc-400">
        <circle cx="12" cy="12" r="10"/>
        <path d="M16 16s-1.5-2-4-2-4 2-4 2"/>
        <line x1="9" x2="9.01" y1="9" y2="9"/>
        <line x1="15" x2="15.01" y1="9" y2="9"/>
      </svg>
    </div>
    <p class="text-zinc-600 dark:text-zinc-400">
      Belum ada mahasiswa yang terpilih
    </p>
    <p class="text-sm text-zinc-500 dark:text-zinc-500 mt-1">
      Mulai undian untuk memilih mahasiswa
    </p>
  </div>

  {/* History content (hidden initially) */}
  <div id="history-content" class="hidden">
    {/* Latest selection (featured) */}
    <div id="latest-selection" class="mb-6 p-6 rounded-2xl bg-gradient-to-br from-candy-purple/10 to-candy-pink/10 border-2 border-candy-purple/30">
      <div class="flex items-center gap-3 mb-3">
        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-candy-purple to-candy-pink flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white">
            <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/>
            <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/>
            <path d="M4 22h16"/>
            <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/>
            <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/>
            <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/>
          </svg>
        </div>
        <div class="flex-1">
          <p class="text-xs font-semibold text-zinc-600 dark:text-zinc-400 uppercase tracking-wide">Terakhir Dipilih</p>
          <p id="latest-name" class="text-2xl font-bold text-zinc-800 dark:text-zinc-100"></p>
        </div>
      </div>
      <p id="latest-time" class="text-sm text-zinc-600 dark:text-zinc-400"></p>
    </div>

    {/* History panel header with download buttons */}
    <div class="mb-4 flex items-center justify-between flex-wrap gap-3">
      <h3 class="text-lg font-semibold text-zinc-800 dark:text-zinc-100 flex items-center gap-2">
        üìä Riwayat Pemilihan
        <span id="history-count-badge" class="px-2.5 py-0.5 rounded-full bg-candy-purple/20 text-candy-purple text-sm font-bold">
          0
        </span>
      </h3>
      
      <div class="flex items-center gap-2">
        {/* Download XLSX button */}
        <button
          type="button"
          id="download-xlsx-btn"
          class="px-3 py-1.5 rounded-lg bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400
                 text-sm font-semibold hover:scale-105 transition-transform duration-200
                 flex items-center gap-1.5"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" x2="12" y1="15" y2="3"/>
          </svg>
          XLSX
        </button>

        {/* Download TXT button */}
        <button
          type="button"
          id="download-txt-btn"
          class="px-3 py-1.5 rounded-lg bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400
                 text-sm font-semibold hover:scale-105 transition-transform duration-200
                 flex items-center gap-1.5"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" x2="12" y1="15" y2="3"/>
          </svg>
          TXT
        </button>

        {/* Clear history button */}
        <button
          type="button"
          id="clear-history-btn"
          class="px-3 py-1.5 rounded-lg bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400
                 text-sm font-semibold hover:scale-105 transition-transform duration-200
                 flex items-center gap-1.5"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 6h18"/>
            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
          </svg>
          Hapus
        </button>
      </div>
    </div>

    {/* History table */}
    <div class="overflow-x-auto rounded-xl border border-zinc-200 dark:border-zinc-700">
      <table class="w-full text-sm">
        <thead class="bg-candy-purple/10 dark:bg-candy-purple/20 border-b border-zinc-200 dark:border-zinc-700">
          <tr>
            <th class="px-4 py-3 text-left font-semibold text-zinc-700 dark:text-zinc-300">No</th>
            <th class="px-4 py-3 text-left font-semibold text-zinc-700 dark:text-zinc-300">Nama</th>
            <th class="px-4 py-3 text-left font-semibold text-zinc-700 dark:text-zinc-300">Waktu</th>
            <th class="px-4 py-3 text-left font-semibold text-zinc-700 dark:text-zinc-300">Status</th>
          </tr>
        </thead>
        <tbody id="history-table-body" class="bg-white/50 dark:bg-zinc-900/50">
          {/* Rows will be inserted here */}
        </tbody>
      </table>
    </div>
  </div>
</div>

{/* Download Modal Popup */}
<div id="download-modal" class="fixed inset-0 z-[70] bg-black/90 hidden items-center justify-center p-4">
  <div class="bg-white dark:bg-zinc-900 rounded-2xl p-6 max-w-md w-full border-2 border-zinc-200 dark:border-zinc-700 shadow-2xl">
    <h3 class="text-xl font-bold text-zinc-800 dark:text-zinc-100 mb-4">üìÅ Info File Export</h3>
    
    <div class="space-y-4">
      <div>
        <label class="block text-sm font-semibold text-zinc-700 dark:text-zinc-300 mb-2">
          Nama Kelas
        </label>
        <input 
          type="text" 
          id="modal-class-name"
          placeholder="Contoh: 3A, 5B, TI-2021"
          class="w-full px-4 py-2.5 rounded-xl border-2 border-zinc-200 dark:border-zinc-700 
                 bg-white dark:bg-zinc-800 text-zinc-800 dark:text-zinc-100
                 focus:border-candy-purple focus:ring-2 focus:ring-candy-purple/20 outline-none
                 transition-all"
        />
      </div>
      
      <div>
        <label class="block text-sm font-semibold text-zinc-700 dark:text-zinc-300 mb-2">
          Mata Kuliah
        </label>
        <input 
          type="text" 
          id="modal-course-name"
          placeholder="Contoh: Algoritma, Basis Data"
          class="w-full px-4 py-2.5 rounded-xl border-2 border-zinc-200 dark:border-zinc-700 
                 bg-white dark:bg-zinc-800 text-zinc-800 dark:text-zinc-100
                 focus:border-candy-purple focus:ring-2 focus:ring-candy-purple/20 outline-none
                 transition-all"
        />
      </div>
      
      <div class="text-xs text-zinc-500 dark:text-zinc-500 bg-zinc-50 dark:bg-zinc-800/50 p-3 rounded-lg">
        üí° Format file: <code class="text-candy-purple font-semibold">NamaKelas-MataKuliah-TanggalJam.xlsx</code>
      </div>
    </div>
    
    <div class="flex gap-3 mt-6">
      <button 
        id="modal-download-btn"
        class="flex-1 px-4 py-2.5 rounded-xl bg-gradient-to-r from-candy-purple to-candy-pink 
               text-white font-semibold hover:scale-105 transition-transform"
      >
        Download
      </button>
      <button 
        id="modal-cancel-btn"
        class="px-4 py-2.5 rounded-xl bg-zinc-200 dark:bg-zinc-700 
               text-zinc-700 dark:text-zinc-300 font-semibold hover:scale-105 transition-transform"
      >
        Batal
      </button>
    </div>
  </div>
</div>

<script>
  import type { HistoryEntry } from '../../lib/slot/slot-animator';

  function initResultsDisplay() {
    const emptyState = document.getElementById('results-empty-state');
    const historyContent = document.getElementById('history-content');
    const latestName = document.getElementById('latest-name');
    const latestTime = document.getElementById('latest-time');
    const historyTableBody = document.getElementById('history-table-body');
    const historyCountBadge = document.getElementById('history-count-badge');
    const clearHistoryBtn = document.getElementById('clear-history-btn');
    const downloadXlsxBtn = document.getElementById('download-xlsx-btn');
    const downloadTxtBtn = document.getElementById('download-txt-btn');

    let currentHistory: HistoryEntry[] = [];

    // Listen for history updates
    window.addEventListener('history-updated', ((e: CustomEvent) => {
      const { history } = e.detail;
      currentHistory = history;
      updateDisplay(history);
    }) as EventListener);

    // Listen for reset
    window.addEventListener('lottery-reset', () => {
      currentHistory = [];
      showEmptyState();
    });

    // Clear history button
    clearHistoryBtn?.addEventListener('click', () => {
      if (confirm('Hapus semua riwayat pemilihan?')) {
        currentHistory = [];
        showEmptyState();
        window.dispatchEvent(new CustomEvent('clear-history-requested'));
      }
    });

    // Download XLSX
    downloadXlsxBtn?.addEventListener('click', () => {
      console.log('[Download] XLSX button clicked');
      if (currentHistory.length === 0) {
        alert('Belum ada data untuk diexport');
        return;
      }
      console.log('[Download] Calling downloadXLSX with', currentHistory.length, 'entries');
      downloadXLSX(currentHistory);
    });

    // Download TXT
    downloadTxtBtn?.addEventListener('click', () => {
      console.log('[Download] TXT button clicked');
      if (currentHistory.length === 0) {
        alert('Belum ada data untuk diexport');
        return;
      }
      console.log('[Download] Calling downloadTXT with', currentHistory.length, 'entries');
      downloadTXT(currentHistory);
    });

    function showEmptyState() {
      emptyState?.classList.remove('hidden');
      historyContent?.classList.add('hidden');
    }

    function updateDisplay(history: HistoryEntry[]) {
      if (history.length === 0) {
        showEmptyState();
        return;
      }

      emptyState?.classList.add('hidden');
      historyContent?.classList.remove('hidden');

      // Get latest entry
      const latest = history[history.length - 1];
      
      // Update latest selection
      if (latestName) latestName.textContent = latest.name;
      if (latestTime) latestTime.textContent = `Terpilih pada ${formatTime(latest.timestamp)}`;

      // Update count badge
      if (historyCountBadge) historyCountBadge.textContent = String(history.length);

      // Update history table
      if (historyTableBody) {
        historyTableBody.innerHTML = history.map((entry) => {
          const statusBadge = entry.status === 'confirmed' 
            ? '<span class="px-2 py-1 rounded-full bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 text-xs font-semibold">‚úì Hadir</span>'
            : '<span class="px-2 py-1 rounded-full bg-gray-100 dark:bg-gray-900/30 text-gray-600 dark:text-gray-400 text-xs font-semibold">- Skip</span>';
          
          return `
            <tr class="border-b border-zinc-100 dark:border-zinc-800 hover:bg-zinc-50 dark:hover:bg-zinc-800/50 transition-colors">
              <td class="px-4 py-3 font-medium text-zinc-600 dark:text-zinc-400">${entry.selectionNumber}</td>
              <td class="px-4 py-3 font-semibold text-zinc-800 dark:text-zinc-100">${escapeHtml(entry.name)}</td>
              <td class="px-4 py-3 text-zinc-600 dark:text-zinc-400">${formatTime(entry.timestamp)}</td>
              <td class="px-4 py-3">${statusBadge}</td>
            </tr>
          `;
        }).join('');
      }
    }

    function downloadXLSX(history: HistoryEntry[]) {
      showDownloadForm((className, courseName) => {
        // Use SheetJS from CDN
        const script = document.createElement('script');
        script.src = 'https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js';
        script.onload = () => {
          const XLSX = (window as any).XLSX;
          
          const data = history.map(entry => ({
            'No': entry.selectionNumber,
            'Nama': entry.name,
            'Waktu': formatFullTime(entry.timestamp),
            'Status': entry.status === 'confirmed' ? 'Hadir' : 'Skip'
          }));

          const ws = XLSX.utils.json_to_sheet(data);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'Riwayat');
          
          const filename = generateFilename(className, courseName, 'xlsx');
          XLSX.writeFile(wb, filename);
        };
        document.head.appendChild(script);
      });
    }

    function downloadTXT(history: HistoryEntry[]) {
      showDownloadForm((className, courseName) => {
        const header = 'No\tNama\tWaktu\tStatus\n';
        const rows = history.map(entry => 
          `${entry.selectionNumber}\t${entry.name}\t${formatFullTime(entry.timestamp)}\t${entry.status === 'confirmed' ? 'Hadir' : 'Skip'}`
        ).join('\n');
        
        const content = header + rows;
        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = generateFilename(className, courseName, 'txt');
        a.click();
        URL.revokeObjectURL(url);
      });
    }

    function showDownloadForm(callback: (className: string, courseName: string) => void) {
      const modal = document.getElementById('download-modal');
      const classInput = document.getElementById('modal-class-name') as HTMLInputElement;
      const courseInput = document.getElementById('modal-course-name') as HTMLInputElement;
      const downloadBtn = document.getElementById('modal-download-btn');
      const cancelBtn = document.getElementById('modal-cancel-btn');
      
      if (!modal || !classInput || !courseInput || !downloadBtn || !cancelBtn) return;
      
      // Clear previous values
      classInput.value = '';
      courseInput.value = '';
      
      // Show modal
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      classInput.focus();
      
      // Handle download
      const handleDownload = () => {
        const className = classInput.value.trim();
        const courseName = courseInput.value.trim();
        
        if (!className || !courseName) {
          alert('Mohon isi nama kelas dan mata kuliah');
          return;
        }
        
        // Hide modal
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        
        // Cleanup listeners
        downloadBtn.removeEventListener('click', handleDownload);
        cancelBtn.removeEventListener('click', handleCancel);
        classInput.removeEventListener('keypress', handleEnter);
        courseInput.removeEventListener('keypress', handleEnter);
        
        callback(className, courseName);
      };
      
      // Handle cancel
      const handleCancel = () => {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        
        // Cleanup listeners
        downloadBtn.removeEventListener('click', handleDownload);
        cancelBtn.removeEventListener('click', handleCancel);
        classInput.removeEventListener('keypress', handleEnter);
        courseInput.removeEventListener('keypress', handleEnter);
      };
      
      // Handle Enter key
      const handleEnter = (e: KeyboardEvent) => {
        if (e.key === 'Enter') {
          handleDownload();
        }
      };
      
      // Attach listeners
      downloadBtn.addEventListener('click', handleDownload);
      cancelBtn.addEventListener('click', handleCancel);
      classInput.addEventListener('keypress', handleEnter);
      courseInput.addEventListener('keypress', handleEnter);
    }

    function generateFilename(className: string, courseName: string, extension: string): string {
      const now = new Date();
      const day = String(now.getDate()).padStart(2, '0');
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const year = now.getFullYear();
      
      // Preserve case, only remove spaces and special characters except hyphens
      const cleanClass = className.replace(/[^a-zA-Z0-9-]/g, '');
      const cleanCourse = courseName.replace(/[^a-zA-Z0-9-]/g, '');
      
      return `SLOT-${cleanClass}-${cleanCourse}-${day}-${month}-${year}.${extension}`;
    }

    function formatTime(date: Date): string {
      return new Date(date).toLocaleTimeString('id-ID', {
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function formatFullTime(date: Date): string {
      return new Date(date).toLocaleString('id-ID', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }

    function escapeHtml(text: string): string {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  }

  // Auto-initialize
  if (typeof window !== 'undefined') {
    document.addEventListener('astro:page-load', initResultsDisplay);
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initResultsDisplay);
    } else {
      initResultsDisplay();
    }
  }
</script>

<style>
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .history-item {
    animation: slideIn 0.3s ease-out;
  }

  /* Custom scrollbar for history list */
  #history-list::-webkit-scrollbar {
    width: 6px;
  }

  #history-list::-webkit-scrollbar-track {
    background: transparent;
  }

  #history-list::-webkit-scrollbar-thumb {
    background: rgba(127, 115, 255, 0.3);
    border-radius: 3px;
  }

  #history-list::-webkit-scrollbar-thumb:hover {
    background: rgba(127, 115, 255, 0.5);
  }
</style>
