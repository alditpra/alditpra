---
import { SITE_CONFIG } from "../../../lib/constants";
import SocialLinks from "./SocialLinks.astro";
import SearchBar from "../../ui/SearchBar.astro";
import { Icon } from "astro-icon/components";
---

<header class="mb-12">
    <div
        class="relative rounded-3xl p-6 sm:p-8 bg-white/70 dark:bg-zinc-900/70 transition-all duration-300"
        id="profile-card"
        style="box-shadow: 0 0 60px -15px rgba(127, 115, 255, 0.15), 0 25px 80px -25px rgba(20, 208, 240, 0.10), 0 8px 32px -8px rgba(0, 0, 0, 0.1);"
    >
        {/* Subtle gradient overlay */}
        <div
            class="absolute inset-0 bg-gradient-to-br from-candy-purple/5 via-transparent to-candy-teal/5 pointer-events-none rounded-3xl"
        >
        </div>

        <div id="collapsible-wrapper">
            <div id="collapsible-inner">
                <div
                    class="relative flex flex-col sm:flex-row items-center sm:items-start gap-5"
                    id="profile-info"
                >
                    {/* Avatar - Simple and Clean */}
                    <div class="shrink-0 group p-6 -m-6">
                        <div class="relative">
                            {/* Avatar Container - no shadow */}
                            <div
                                class="relative rounded-full transition-transform duration-500 group-hover:scale-105 group-hover:rotate-3"
                            >
                                <img
                                    srcset="/avatar-desktop.webp 208w, /avatar-mobile.webp 308w"
                                    sizes="(min-width: 640px) 104px, 154px"
                                    src="/avatar-desktop.webp"
                                    alt={SITE_CONFIG.name}
                                    width="208"
                                    height="208"
                                    class="w-24 h-24 sm:w-28 sm:h-28 rounded-full object-cover border-4 border-white"
                                    loading="eager"
                                />
                                {/* Online Status Indicator */}
                                <div
                                    class="absolute bottom-2 right-2 w-5 h-5 bg-candy-teal rounded-full border-3 border-white shadow-md"
                                >
                                    <div
                                        class="absolute inset-0 rounded-full bg-candy-teal animate-ping opacity-75"
                                    >
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Info */}
                    <div class="flex-1 text-center sm:text-left">
                        {/* Name with static candy color */}
                        <h1
                            class="text-3xl sm:text-4xl font-extrabold tracking-tight mb-1"
                            style="color: var(--candy-purple); filter: drop-shadow(0 2px 8px rgba(127, 115, 255, 0.2));"
                        >
                            {SITE_CONFIG.name}
                        </h1>

                        {/* Tagline - Typewriter Effect with Gradient */}
                        <div
                            class="mb-4 h-8 flex items-center justify-center sm:justify-start"
                        >
                            <p
                                id="typewriter-text"
                                class="text-lg sm:text-xl font-medium bg-gradient-to-r from-candy-blue to-candy-pink bg-clip-text text-transparent inline-block"
                                data-phrases={JSON.stringify(
                                    SITE_CONFIG.profilePhrases,
                                )}
                            >
                            </p>
                            <span
                                class="w-[3px] h-6 bg-candy-purple ml-1 animate-blink"
                            ></span>
                        </div>

                        {/* Description - improved styling */}
                        <p
                            class="text-base sm:text-lg font-normal leading-relaxed mb-5"
                            style="color: var(--text-secondary);"
                        >
                            Built with Astro 5 and Tailwind CSS 4. Leveraging{
                                " "
                            }
                            <a
                                href="https://docs.google.com/spreadsheets/d/1Tmj_ERd9KKvaKoGPEkczNb8iAJpTfkGHl7OUoahQlW0/edit?usp=drive_link"
                                target="_blank"
                                rel="noopener noreferrer"
                                class="inline-flex items-center gap-1 text-candy-purple hover:text-candy-blue font-semibold transition-colors underline decoration-candy-purple/30 hover:decoration-candy-blue/50"
                            >
                                Google Sheets
                                <Icon
                                    name="lucide:external-link"
                                    class="w-4 h-4"
                                />
                            </a>
                            {" "}as a headless CMS for effortless content
                            updates.
                        </p>

                        <SocialLinks />
                    </div>
                </div>

                {/* Divider */}
                <div
                    class="h-px my-6"
                    id="profile-divider"
                    style="background: linear-gradient(to right, transparent, var(--divider), transparent);"
                >
                </div>
            </div>
        </div>

        {/* Search Bar */}
        <div class="relative" id="search-wrapper">
            <SearchBar />
        </div>
    </div>
</header>

<script>
    function initTypewriter() {
        const element = document.getElementById("typewriter-text");
        if (!element) return;

        // Phrases to cycle through
        // Get phrases from data attribute (set in constants.ts)
        let phrases = [];
        try {
            phrases = JSON.parse(element.dataset.phrases || "[]");
        } catch (e) {
            phrases = ["Personal Link Directory"]; // Fallback
        }

        if (phrases.length === 0) phrases = ["Personal Link Directory"];

        // Settings
        const typingSpeed = 50;
        const deletingSpeed = 30;
        const pauseEnd = 2000; // Wait before deleting
        const pauseStart = 2000; // Wait before typing next

        let phraseIndex = 0;
        let charIndex = 0;
        let isDeleting = false;
        let typeTimeout;

        // Clear any existing timeouts
        if ((element as any)._typeTimeout)
            clearTimeout((element as any)._typeTimeout);

        function type() {
            const currentPhrase = phrases[phraseIndex];

            if (isDeleting) {
                element.textContent = currentPhrase.substring(0, charIndex - 1);
                charIndex--;
            } else {
                element.textContent = currentPhrase.substring(0, charIndex + 1);
                charIndex++;
            }

            let typeSpeed = isDeleting ? deletingSpeed : typingSpeed;

            // Typing logic
            if (!isDeleting && charIndex === currentPhrase.length) {
                // Done typing phrase
                isDeleting = true;

                // If last phrase, wait 10 seconds (10000ms) before deleting/looping
                // Otherwise wait normal pauseEnd (2000ms)
                if (phraseIndex === phrases.length - 1) {
                    typeSpeed = 10000;
                } else {
                    typeSpeed = pauseEnd;
                }
            } else if (isDeleting && charIndex === 0) {
                // Done deleting phrase
                isDeleting = false;
                phraseIndex = (phraseIndex + 1) % phrases.length;
                typeSpeed = pauseStart;
            }

            // Random variation to make it look human (only when typing)
            if (!isDeleting && charIndex < currentPhrase.length) {
                typeSpeed += Math.random() * 30;
            }

            (element as any)._typeTimeout = setTimeout(type, typeSpeed);
        }

        // Initialize state
        element.textContent = "";
        charIndex = 0;
        isDeleting = false;

        // Start typing
        setTimeout(type, 500);
    }

    // Initialize
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initTypewriter);
    } else {
        initTypewriter();
    }
</script>

<style>
    /* Blinking cursor animation */
    @keyframes blink {
        0%,
        100% {
            opacity: 1;
        }
        50% {
            opacity: 0;
        }
    }
    .animate-blink {
        animation: blink 1s step-end infinite;
    }

    /* Profile collapse animation using grid-template-rows for performance */
    #collapsible-wrapper {
        display: grid;
        grid-template-rows: 1fr;
        opacity: 1;
        transition:
            grid-template-rows 0.5s cubic-bezier(0.4, 0, 0.2, 1),
            opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    #collapsible-inner {
        overflow: hidden;
    }

    /* Search wrapper base styles */
    #search-wrapper {
        transition: padding 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        padding-top: 0;
        padding-bottom: 0;
    }

    /* DESKTOP ONLY: Collapse when search is focused or has text */
    @media (min-width: 640px) {
        /* Use :has() to detect if search input is focused OR if search wrapper has text */
        #profile-card:has(#search-input:focus) #collapsible-wrapper,
        #profile-card:has(.has-text) #collapsible-wrapper {
            grid-template-rows: 0fr;
            opacity: 0;
            pointer-events: none;
        }

        /* Adjust padding/spacing when collapsed */
        #profile-card:has(#search-input:focus) #search-wrapper,
        #profile-card:has(.has-text) #search-wrapper {
            padding-top: 0.25rem;
            padding-bottom: 0.25rem;
        }
    }

    /* MOBILE: Force visible */
    @media (max-width: 639px) {
        #collapsible-wrapper {
            grid-template-rows: 1fr !important;
            opacity: 1 !important;
            pointer-events: auto !important;
        }
    }
</style>
