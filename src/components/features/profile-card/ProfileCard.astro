---
import { SITE_CONFIG } from "../../../lib/constants";
import SocialLinks from "./SocialLinks.astro";
import SearchBar from "../../ui/SearchBar.astro";
import { Icon } from "astro-icon/components";

interface Props {
    variant?: "default" | "sidebar";
}

const { variant = "default" } = Astro.props;
const isSidebar = variant === "sidebar";
---

<div class={isSidebar ? "" : "mb-12"}>
    <div
        class={`relative rounded-3xl transition-all duration-300 ${
            isSidebar
                ? "p-4 bg-white/60 dark:bg-zinc-900/60"
                : "p-6 sm:p-8 bg-white/70 dark:bg-zinc-900/70"
        }`}
        id="profile-card"
        style={!isSidebar
            ? "box-shadow: 0 0 60px -15px rgba(127, 115, 255, 0.15), 0 25px 80px -25px rgba(20, 208, 240, 0.10), 0 8px 32px -8px rgba(0, 0, 0, 0.1);"
            : "box-shadow: 0 4px 20px -5px rgba(127, 115, 255, 0.1), 0 2px 10px rgba(0, 0, 0, 0.05);"}
    >
        {/* Subtle gradient overlay */}
        <div
            class="absolute inset-0 bg-gradient-to-br from-candy-purple/5 via-transparent to-candy-teal/5 pointer-events-none rounded-3xl"
        >
        </div>

        {
            !isSidebar && (
                <div
                    class={`relative flex flex-col items-center gap-${isSidebar ? "3" : "3"}`}
                    id="profile-info"
                >
                    {/* Avatar - Simple and Clean */}
                    <div
                        class={`shrink-0 group ${isSidebar ? "p-2 -m-2" : "p-6 -m-6"}`}
                    >
                        <div class="relative">
                            {/* Avatar Container - no shadow */}
                            <div class="relative rounded-full transition-transform duration-500 group-hover:scale-105 group-hover:rotate-3">
                                <img
                                    srcset="/avatar-desktop.webp 208w, /avatar-mobile.webp 308w"
                                    sizes={
                                        isSidebar
                                            ? "60px"
                                            : "(min-width: 640px) 104px, 154px"
                                    }
                                    src="/avatar-desktop.webp"
                                    alt={SITE_CONFIG.name}
                                    width={isSidebar ? 120 : 208}
                                    height={isSidebar ? 120 : 208}
                                    class={
                                        isSidebar
                                            ? "w-16 h-16 rounded-full object-cover border-3 border-white"
                                            : "w-24 h-24 sm:w-28 sm:h-28 rounded-full object-cover border-4 border-white"
                                    }
                                    loading="eager"
                                />

                                {/* Online Status Indicator */}
                                <div
                                    class={`absolute ${isSidebar ? "bottom-1 right-1 w-4 h-4" : "bottom-2 right-2 w-5 h-5"} bg-candy-teal rounded-full border-3 border-white shadow-md`}
                                >
                                    <div class="absolute inset-0 rounded-full bg-candy-teal animate-ping opacity-75" />
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Info */}
                    <div class="flex-1 text-center">
                        {/* Name with static candy color */}
                        <h1
                            class={
                                isSidebar
                                    ? "text-xl font-extrabold tracking-tight mb-1"
                                    : "text-3xl sm:text-4xl font-extrabold tracking-tight mb-1"
                            }
                            style="color: var(--candy-purple); filter: drop-shadow(0 2px 8px rgba(127, 115, 255, 0.2));"
                        >
                            {SITE_CONFIG.name}
                        </h1>

                        {/* Tagline - Typewriter Effect with Gradient */}

                        {/* Mobile: Static Text (Performance Optimized) */}
                        <div class="mb-3 block sm:hidden">
                            <p class="text-lg font-medium bg-gradient-to-r from-candy-blue to-candy-pink bg-clip-text text-transparent inline-block">
                                {SITE_CONFIG.profilePhrases[0]}
                            </p>
                        </div>

                        {/* Desktop: Animated Typewriter */}
                        <div
                            class={`mb-${isSidebar ? "3" : "4"} ${isSidebar ? "h-6" : "h-8"} hidden sm:flex items-center justify-center`}
                        >
                            <p
                                id={`typewriter-text-${isSidebar ? "sidebar" : "default"}`}
                                class={
                                    isSidebar
                                        ? "text-sm font-medium bg-gradient-to-r from-candy-blue to-candy-pink bg-clip-text text-transparent inline-block"
                                        : "text-lg sm:text-xl font-medium bg-gradient-to-r from-candy-blue to-candy-pink bg-clip-text text-transparent inline-block"
                                }
                                data-phrases={JSON.stringify(
                                    SITE_CONFIG.profilePhrases,
                                )}
                            />
                            <span
                                class={`w-[2px] ${isSidebar ? "h-4" : "h-6"} bg-candy-purple ml-1 animate-blink`}
                            />
                        </div>

                        {/* Description - improved styling (skip for sidebar) */}
                        {!isSidebar && (
                            <p class="text-center text-zinc-600 dark:text-zinc-300 leading-relaxed max-w-md mx-auto mb-4">
                                An open-source project built with Astro 5 and
                                Tailwind CSS 4. Leveraging{" "}
                                <a
                                    href="https://docs.google.com/spreadsheets/d/1Tmj_ERd9KKvaKoGPEkczNb8iAJpTfkGHl7OUoahQlW0/edit?usp=drive_link"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    class="inline-flex items-center gap-1 text-candy-purple hover:text-candy-blue font-semibold transition-colors underline decoration-candy-purple/30 hover:decoration-candy-blue/50"
                                >
                                    Google Sheets
                                    <Icon
                                        name="lucide:external-link"
                                        class="w-3.5 h-3.5"
                                    />
                                </a>{" "}
                                as a headless CMS for effortless content
                                updates.
                            </p>
                        )}

                        <SocialLinks
                            variant={isSidebar ? "compact" : "default"}
                        />
                    </div>
                </div>
            )
        }

        {
            isSidebar && (
                <div
                    class={`relative flex flex-col items-center gap-3`}
                    id="profile-info"
                >
                    {/* Avatar - Simple and Clean */}
                    <div class="shrink-0 group p-2 -m-2">
                        <div class="relative">
                            {/* Avatar Container - no shadow */}
                            <div class="relative rounded-full transition-transform duration-500 group-hover:scale-105 group-hover:rotate-3">
                                <img
                                    srcset="/avatar-desktop.webp 208w, /avatar-mobile.webp 308w"
                                    sizes="60px"
                                    src="/avatar-desktop.webp"
                                    alt={SITE_CONFIG.name}
                                    width={120}
                                    height={120}
                                    class="w-24 h-24 rounded-full object-cover border-4 border-white"
                                    loading="eager"
                                />
                                {/* Online Status Indicator */}
                                <div class="absolute bottom-2 right-2 w-5 h-5 bg-candy-teal rounded-full border-3 border-white shadow-md">
                                    <div class="absolute inset-0 rounded-full bg-candy-teal animate-ping opacity-75" />
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Info */}
                    <div class="flex-1 text-center">
                        {/* Name with static candy color */}
                        <h1
                            class="text-xl font-extrabold tracking-tight mb-1"
                            style="color: var(--candy-purple); filter: drop-shadow(0 2px 8px rgba(127, 115, 255, 0.2));"
                        >
                            {SITE_CONFIG.name}
                        </h1>

                        {/* Tagline - Typewriter Effect with Gradient */}
                        <div class="mb-3 h-6 flex items-center justify-center">
                            <p
                                id="typewriter-text-sidebar"
                                class="text-sm font-medium bg-gradient-to-r from-candy-blue to-candy-pink bg-clip-text text-transparent inline-block"
                                data-phrases={JSON.stringify(
                                    SITE_CONFIG.profilePhrases,
                                )}
                            />
                            <span class="w-[2px] h-4 bg-candy-purple ml-1 animate-blink" />
                        </div>

                        <SocialLinks variant="compact" />
                    </div>
                </div>
            )
        }

        {/* Search Bar - Only for default variant (mobile) */}
        {
            !isSidebar && (
                <div class="w-full flex flex-col items-center">
                    {/* Visual Divider */}
                    <div class="w-full px-12 my-3 opacity-60">
                        <div
                            class="h-px w-full"
                            style="background: linear-gradient(to right, transparent, rgba(127, 115, 255, 0.3), transparent);"
                        />
                    </div>
                    <div class="w-full">
                        <SearchBar id="search-input-mobile" />
                    </div>
                </div>
            )
        }
    </div>
</div>

<script>
    function initTypewriter() {
        // Find all typewriter text elements (both sidebar and default variants)
        const elements = document.querySelectorAll('[id^="typewriter-text-"]');

        elements.forEach((element) => {
            if (!element) return;

            // Performance: detailed visibility check
            // Don't run animation if element is hidden (mobile view optimization)
            if (element.offsetParent === null) return;

            // Get phrases from data attribute
            let phrases = [];
            try {
                phrases = JSON.parse(element.dataset.phrases || "[]");
            } catch (e) {
                phrases = ["Personal Link Directory"];
            }

            if (phrases.length === 0) phrases = ["Personal Link Directory"];

            // Settings
            const typingSpeed = 50;
            const deletingSpeed = 30;
            const pauseEnd = 2000;
            const pauseStart = 500;

            let phraseIndex = 0;
            let charIndex = 0;
            let isDeleting = false;

            // Clear any existing timeouts
            if ((element as any)._typeTimeout)
                clearTimeout((element as any)._typeTimeout);

            function getCommonPrefixLength(s1, s2) {
                let i = 0;
                while (i < s1.length && i < s2.length && s1[i] === s2[i]) {
                    i++;
                }
                return i;
            }

            function type() {
                const currentPhrase = phrases[phraseIndex];
                const nextPhrase = phrases[(phraseIndex + 1) % phrases.length];
                const commonPrefixLen = getCommonPrefixLength(
                    currentPhrase,
                    nextPhrase,
                );

                if (isDeleting) {
                    element.textContent = currentPhrase.substring(
                        0,
                        charIndex - 1,
                    );
                    charIndex--;
                } else {
                    element.textContent = currentPhrase.substring(
                        0,
                        charIndex + 1,
                    );
                    charIndex++;
                }

                let typeSpeed = isDeleting ? deletingSpeed : typingSpeed;

                if (!isDeleting && charIndex === currentPhrase.length) {
                    isDeleting = true;
                    if (phraseIndex === phrases.length - 1) {
                        typeSpeed = 10000;
                    } else {
                        typeSpeed = pauseEnd;
                    }
                } else if (isDeleting && charIndex === commonPrefixLen) {
                    isDeleting = false;
                    phraseIndex = (phraseIndex + 1) % phrases.length;
                    typeSpeed = pauseStart;
                }

                if (!isDeleting && charIndex < currentPhrase.length) {
                    typeSpeed += Math.random() * 30;
                }

                (element as any)._typeTimeout = setTimeout(type, typeSpeed);
            }

            // Initialize state
            element.textContent = "";
            charIndex = 0;
            isDeleting = false;

            // Start typing
            setTimeout(type, 500);
        });
    }

    // Initialize
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initTypewriter);
    } else {
        initTypewriter();
    }
</script>

<style>
    /* Blinking cursor animation */
    @keyframes blink {
        0%,
        100% {
            opacity: 1;
        }
        50% {
            opacity: 0;
        }
    }
    .animate-blink {
        animation: blink 1s step-end infinite;
    }
</style>
