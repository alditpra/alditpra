---
/**
 * ToolPageLayout.astro
 * Shared layout component for tool pages (/tumbal, /slot, /santet)
 * ensures consistent spacing, headers, and navigation.
 */
import Layout from "../layouts/Layout.astro";
import MeshGradient from "../components/ui/MeshGradient.astro";
import SafeIcon from "../components/ui/SafeIcon.astro";
import { getAllLinks, getCategories } from "../lib/data";
import { getLinkColorIndex } from "../lib/category-utils";
import { candyColors } from "../lib/colors";

interface Props {
    title: string;
    subtitle?: string; // Short title for back button or small headers
    description: string;
    backUrl?: string;
    icon?: string; // Icon name for astro-icon
    themeColor?: string; // e.g. "candy-purple", "candy-orange"
}

const {
    title,
    subtitle,
    description,
    backUrl = "/",
    icon,
    themeColor: propThemeColor = "candy-purple",
} = Astro.props;

let activeIcon = icon;

// Auto-detect theme color based on current URL
let activeThemeColor = propThemeColor;
if (import.meta.env.SSR || true) {
    // Always run detection on server/build
    try {
        const currentPath = Astro.url.pathname;
        const links = await getAllLinks();
        const categories = await getCategories();

        // Find link matching current path (handle trailing slash)
        const normalizedPath =
            currentPath.endsWith("/") && currentPath !== "/"
                ? currentPath.slice(0, -1)
                : currentPath;

        const matchingLink = links.find((l) => {
            if (!l.link) return false;
            const linkUrl =
                l.link.endsWith("/") && l.link !== "/"
                    ? l.link.slice(0, -1)
                    : l.link;
            return linkUrl === normalizedPath;
        });

        if (matchingLink) {
            const colorIndex = getLinkColorIndex(
                matchingLink.id,
                links,
                categories,
            );
            const color = candyColors[colorIndex % candyColors.length];
            // candyColors has name: "purple", we need "candy-purple"
            activeThemeColor = `candy-${color.name}`;

            // Auto-detect icon if not override provided
            if (!icon && matchingLink.icon) {
                // We can assign to a let variable but 'icon' is const from destructuring
                // So we need a mutable activeIcon variable
                // Ensure lucide prefix if missing
                const iconName = matchingLink.icon;
                activeIcon = iconName.startsWith("lucide:")
                    ? iconName
                    : `lucide:${iconName}`;
            }
        }
    } catch (e) {
        console.error("Error detecting theme color:", e);
    }
}

// Helper to get color classes based on theme
// We use style vars for dynamic colors to avoid huge class maps
const cssVars = {
    "--theme-color": `var(--${activeThemeColor})`,
};
---

<Layout title={title} description={description}>
    <main class="min-h-screen relative" style={cssVars}>
        {/* Background */}
        <MeshGradient />

        <div
            class="relative z-10 container mx-auto px-4 py-8 sm:py-12 max-w-7xl"
        >
            {/* Back Navigation */}
            <slot name="back-nav">
                <a
                    href={backUrl}
                    class="inline-flex items-center gap-2 px-5 py-3 mb-6 rounded-3xl transition-all duration-300
                 bg-[var(--theme-color)]/20 border border-[var(--theme-color)]/30
                 hover:-translate-y-1 hover:scale-[1.02] hover:shadow-lg group"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        class="text-[color:color-mix(in_srgb,var(--theme-color),black_30%)] dark:text-[color:color-mix(in_srgb,var(--theme-color),white_40%)] transition-transform group-hover:-translate-x-1"
                    >
                        <path d="m12 19-7-7 7-7"></path>
                        <path d="M19 12H5"></path>
                    </svg>
                    <span
                        class="font-semibold text-[color:color-mix(in_srgb,var(--theme-color),black_30%)] dark:text-[color:color-mix(in_srgb,var(--theme-color),white_40%)]"
                    >
                        Kembali
                    </span>
                </a>
            </slot>

            {/* Header */}
            <div
                class="relative bg-white/70 dark:bg-zinc-900/70 rounded-3xl p-6 sm:p-8 mb-8 border border-white/60 dark:border-zinc-700/50 shadow-xl overflow-hidden transition-all duration-300"
            >
                {/* Subtle gradient overlay */}
                <div
                    class="absolute inset-0 bg-gradient-to-br from-[var(--theme-color)]/5 via-transparent to-candy-teal/5 pointer-events-none rounded-3xl"
                >
                </div>

                <div class="relative flex items-start gap-5 sm:gap-6">
                    {/* Header Icon */}
                    <div
                        class="shrink-0 w-16 h-16 sm:w-20 sm:h-20 rounded-2xl bg-[var(--theme-color)]/20 flex items-center justify-center shadow-lg"
                        style="box-shadow: 0 0 25px -5px var(--theme-color), 0 8px 25px -10px var(--theme-color);"
                    >
                        <slot name="header-icon">
                            {
                                activeIcon ? (
                                    <SafeIcon
                                        name={activeIcon}
                                        fallbackText={title}
                                        class="w-8 h-8 sm:w-10 sm:h-10 text-[color:color-mix(in_srgb,var(--theme-color),black_30%)] dark:text-[color:color-mix(in_srgb,var(--theme-color),white_40%)]"
                                        fallbackClass="text-2xl font-bold"
                                    />
                                ) : (
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        width="32"
                                        height="32"
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="2"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        class="text-[color:color-mix(in_srgb,var(--theme-color),black_30%)] dark:text-[color:color-mix(in_srgb,var(--theme-color),white_40%)]"
                                    >
                                        <circle cx="12" cy="12" r="10" />
                                        <polyline points="12 6 12 12 16 14" />
                                    </svg>
                                )
                            }
                        </slot>
                    </div>

                    <div class="flex-1 min-w-0">
                        {
                            subtitle && (
                                <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full mb-2 bg-[var(--theme-color)]/10 border border-[var(--theme-color)]/20">
                                    <span class="text-xs font-semibold text-[color:color-mix(in_srgb,var(--theme-color),black_20%)] dark:text-[color:color-mix(in_srgb,var(--theme-color),white_20%)]">
                                        {subtitle}
                                    </span>
                                </div>
                            )
                        }
                        <h1
                            class="text-2xl sm:text-3xl font-extrabold text-[color:color-mix(in_srgb,var(--theme-color),black_30%)] dark:text-[color:color-mix(in_srgb,var(--theme-color),white_40%)] mb-2"
                        >
                            {title}
                        </h1>
                        <p
                            class="text-zinc-600 dark:text-zinc-400 leading-relaxed text-base sm:text-lg"
                        >
                            {description}
                        </p>
                        <slot name="header-extra" />
                    </div>

                    <slot name="header-action" />
                </div>
            </div>

            {/* Main Content Info / Warning checks etc if needed */}

            {/* Page Content */}
            <slot />
        </div>
    </main>
</Layout>
